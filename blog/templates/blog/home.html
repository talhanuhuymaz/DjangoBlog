{% extends 'blog/base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
{% load static %}

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/home/">
            <i class="fas fa-blog"></i> BlogSpace
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <form class="d-flex ms-auto me-3 search-form" method="GET" action="/home/">
                <div class="input-group">
                    <input class="form-control" type="search" placeholder="Search posts..." name="search" value="{{ search_query }}" aria-label="Search">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>

            <div class="navbar-nav">
                <button onclick="toggleTheme()" class="theme-toggle" title="Toggle theme">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>
                {% if user.is_authenticated %}
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-2"></i>
                        {{ user.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/profile/"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="/myposts/"><i class="fas fa-file-alt me-2"></i>My Posts</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="POST" action="/signout/" class="dropdown-item p-0">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item"><i class="fas fa-sign-out-alt me-2"></i>Sign Out</button>
                            </form>
                        </li>
                    </ul>
                </div>
                {% else %}
                <div class="nav-item">
                    <a href="/login/" class="nav-link"><i class="fas fa-sign-in-alt me-2"></i>Login</a>
                </div>
                <div class="nav-item">
                    <a href="/signup/" class="nav-link"><i class="fas fa-user-plus me-2"></i>Sign Up</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="custom-container">
    <div class="row g-4">
        {% for post in posts %}
        <div class="col-12 fade-in">
            <div class="card post-card">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-center mb-3">
                        <div class="d-flex align-items-center me-auto mb-2 mb-sm-0">
                            <a href="{% url 'user-profile' post.author.username %}" class="text-decoration-none">
                                {% if post.author.profile.avatar %}
                                <img src="{{ post.author.profile.avatar.url }}" 
                                     alt="Profile Avatar" 
                                     class="rounded-circle me-2"
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                {% elif post.author.profile.selected_avatar %}
                                <div class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; background-color: {{ post.author.profile.selected_avatar_color }};">
                                    <i class="{{ post.author.profile.selected_avatar }} text-white" style="font-size: 1.2rem;"></i>
                                </div>
                                {% else %}
                                <div class="rounded-circle me-2 d-flex align-items-center justify-content-center bg-primary text-white"
                                     style="width: 40px; height: 40px;">
                                    {{ post.author.username|make_list|first|upper }}
                                </div>
                                {% endif %}
                                <span class="fw-semibold text-body">{{ post.author.username }}</span>
                            </a>
                        </div>
                        <div class="d-flex align-items-center">
                            <small class="text-muted me-3">
                                <i class="fas fa-clock me-1"></i>{{ post.date_posted|date:"M d, Y" }}
                            </small>
                            {% if user.is_authenticated %}
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary like-btn" 
                                        data-post-id="{{ post.id }}"
                                        data-liked="{% if post.id in liked_posts %}true{% else %}false{% endif %}">
                                    <i class="fas fa-heart{% if post.id not in liked_posts %}-o{% endif %} me-1"></i>
                                    <span class="like-count">{{ post.likes.count }}</span>
                                </button>
                                {% if user == post.author %}
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editPostModal{{ post.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletePostModal{{ post.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <h5 class="card-title mb-3">{{ post.title }}</h5>
                    
                    {% if post.image %}
                    <div class="post-image-container mb-3">
                        <img src="{{ post.image.url }}" 
                             alt="Post image" 
                             class="img-fluid rounded w-100"
                             style="max-height: 400px; object-fit: cover; cursor: pointer;"
                             data-bs-toggle="modal" 
                             data-bs-target="#imageModal{{ post.id }}">
                    </div>
                    {% endif %}
                    
                    <p class="card-text post-content">{{ post.content }}</p>
                </div>
            </div>
        </div>

        <!-- Image Modal -->
        {% if post.image %}
        <div class="modal fade" id="imageModal{{ post.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body p-0">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close"></button>
                        <img src="{{ post.image.url }}" 
                             alt="Post image" 
                             class="img-fluid w-100"
                             style="border-radius: 0.5rem;">
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% empty %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    {% if search_query %}
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4>No results found for "{{ search_query }}"</h4>
                        <p class="mb-0">Try a different search term or <a href="/home/" class="text-primary">view all posts</a>.</p>
                    {% else %}
                        <i class="fas fa-feather-alt fa-3x text-muted mb-3"></i>
                        <h4>No posts yet</h4>
                        <p class="mb-0">Be the first to create a post!</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Create Post Modal -->
{% if user.is_authenticated %}
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">Create New Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" enctype="multipart/form-data" action="{% url 'create-post' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content</label>
                        <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">Image (optional)</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Post</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Floating Action Button for Create Post -->
<button class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow" 
        style="width: 60px; height: 60px; z-index: 1000;"
        data-bs-toggle="modal" 
        data-bs-target="#createPostModal">
    <i class="fas fa-plus fa-lg"></i>
</button>
{% endif %}

{% endblock %}
